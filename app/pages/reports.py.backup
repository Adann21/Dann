import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime
import os
from app.auth import get_current_user, get_current_role
from models.pso_rf_model import pso_rf_model

def show_reports():
    user = get_current_user()
    role = get_current_role()
    
    st.title("üìã Laporan Prediksi Kelulusan")
    st.markdown(f"**Login sebagai:** {role.replace('_', ' ').title()}")
    
    # Check if data and model exist
    if 'data_siswa' not in st.session_state:
        st.warning("‚ö†Ô∏è Silakan upload data siswa terlebih dahulu di menu Dashboard")
        return
    
    if not st.session_state.get('model_trained', False):
        st.warning("‚ö†Ô∏è Silakan train model terlebih dahulu di menu Prediksi")
        return
    
    df = st.session_state.data_siswa
    model_results = st.session_state.model_results
    
    # Generate predictions for all data
    try:
        from models.data_processor import data_processor
        X, y = data_processor.prepare_data(df)
        predictions, probabilities = pso_rf_model.predict(X)
        
        # Add predictions to dataframe
        df_pred = df.copy()
        df_pred['prediksi_kelulusan'] = predictions
        df_pred['probabilitas_lulus'] = probabilities[:, 1]
        df_pred['probabilitas_tidak_lulus'] = probabilities[:, 0]
        
        st.session_state.df_with_predictions = df_pred
        
    except Exception as e:
        st.error(f"‚ùå Error generating predictions: {e}")
        return
    
    # Report sections
    st.markdown("---")
    st.subheader("üìä Ringkasan Laporan")
    
    # Summary statistics
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        total_siswa = len(df_pred)
        st.metric("Total Siswa", total_siswa)
    
    with col2:
        prediksi_lulus = df_pred['prediksi_kelulusan'].sum()
        st.metric("Prediksi Lulus", prediksi_lulus)
    
    with col3:
        prediksi_tidak_lulus = total_siswa - prediksi_lulus
        st.metric("Prediksi Tidak Lulus", prediksi_tidak_lulus)
    
    with col4:
        persentase_lulus = (prediksi_lulus / total_siswa) * 100
        st.metric("Persentase Lulus", f"{persentase_lulus:.1f}%")
    
    # Detailed predictions table
    st.markdown("---")
    st.subheader("üìã Detail Prediksi per Siswa")
    
    # Filter options
    col1, col2 = st.columns(2)
    
    with col1:
        filter_kelas = st.multiselect(
            "Filter Kelas:",
            options=df_pred['kelas'].unique(),
            default=df_pred['kelas'].unique()
        )
    
    with col2:
        filter_prediksi = st.multiselect(
            "Filter Prediksi:",
            options=['LULUS', 'TIDAK LULUS'],
            default=['LULUS', 'TIDAK LULUS']
        )
    
    # Apply filters
    filtered_df = df_pred[df_pred['kelas'].isin(filter_kelas)]
    if 'LULUS' in filter_prediksi and 'TIDAK LULUS' not in filter_prediksi:
        filtered_df = filtered_df[filtered_df['prediksi_kelulusan'] == 1]
    elif 'TIDAK LULUS' in filter_prediksi and 'LULUS' not in filter_prediksi:
        filtered_df = filtered_df[filtered_df['prediksi_kelulusan'] == 0]
    
    # Display filtered data
    st.dataframe(
        filtered_df[[
            'nis', 'nama', 'kelas', 'nilai_matematika', 'nilai_bahasa_indonesia',
            'nilai_bahasa_inggris', 'nilai_kejuruan', 'kehadiran', 'sikap',
            'prediksi_kelulusan', 'probabilitas_lulus'
        ]].rename(columns={
            'prediksi_kelulusan': 'Prediksi',
            'probabilitas_lulus': 'Prob Lulus'
        }).style.format({
            'Prob Lulus': '{:.2%}'
        }).apply(
            lambda x: ['background-color: #d4edda' if x['Prediksi'] == 1 else 'background-color: #f8d7da' for _ in x],
            axis=1
        )
    )
    
    # Export options
    st.markdown("---")
    st.subheader("üì§ Export Laporan")
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Export to CSV
        csv_data = filtered_df.to_csv(index=False)
        st.download_button(
            label="üíæ Download CSV",
            data=csv_data,
            file_name=f"laporan_prediksi_{datetime.now().strftime('%Y%m%d_%H%M')}.csv",
            mime="text/csv"
        )
    
    with col2:
        # Export summary report
        summary_report = f"""
LAPORAN PREDIKSI KELULUSAN
SMKN 1 SANDAI
Tanggal: {datetime.now().strftime('%d/%m/%Y %H:%M')}

STATISTIK:
- Total Siswa: {total_siswa}
- Prediksi Lulus: {prediksi_lulus}
- Prediksi Tidak Lulus: {prediksi_tidak_lulus}
- Persentase Kelulusan: {persentase_lulus:.1f}%
- Akurasi Model: {model_results['accuracy']:.2%}

REKOMENDASI:
- Fokus pada siswa dengan prediksi tidak lulus
- Tingkatkan nilai pada mata pelajaran dengan importance tinggi
        """
        
        st.download_button(
            label="üìÑ Download Summary",
            data=summary_report,
            file_name=f"summary_laporan_{datetime.now().strftime('%Y%m%d_%H%M')}.txt",
            mime="text/plain"
        )
    
    # Model performance
    st.markdown("---")
    st.subheader("ü§ñ Performa Model")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.metric("Akurasi Model", f"{model_results['accuracy']:.2%}")
    
    with col2:
        st.metric("Status Model", "Trained")
    
    # Feature importance chart
    st.subheader("üìà Feature Importance")
    importance_df = pd.DataFrame({
        'Feature': list(model_results['feature_importance'].keys()),
        'Importance': list(model_results['feature_importance'].values())
    }).sort_values('Importance', ascending=True)
    
    st.bar_chart(importance_df.set_index('Feature'))

if __name__ == "__main__":
    show_reports()
